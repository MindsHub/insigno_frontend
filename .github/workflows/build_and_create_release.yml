name: Build and create release
on: workflow_dispatch

env:
  # these directories are the same as in F-Droid's buildserver, ensuring reproducibility
  BUILD_DIR: /home/vagrant/build/org.mindshub.insigno
  PUB_CACHE: /home/vagrant/build/org.mindshub.insigno/.pub-cache

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Check out repository
        uses: actions/checkout@v3
      - name: Move repo to correct place
        run: |
          sudo mkdir -p "$BUILD_DIR"
          sudo chown runner "$BUILD_DIR"
          mv ${{ github.workspace }}/* "$BUILD_DIR"
      - name: Extract version and version code
        run: |
          cd "$BUILD_DIR"
          echo "VERSION=$(sed -nE 's~^version: ?([^\+]+)\+(.*)$~\1~p' pubspec.yaml)" >> $GITHUB_ENV
          echo "VERSION_CODE=$(sed -nE 's~^version: ?([^\+]+)\+(.*)$~\2~p' pubspec.yaml)" >> $GITHUB_ENV
      - name: Print version, version code and build directory
        run: |
          echo "Version ${{ env.VERSION }}, version code ${{ env.VERSION_CODE }}, build directory $BUILD_DIR"
      - name: Clone flutter
        run: |
          cd "$BUILD_DIR"
          git submodule init
          git submodule update
      - name: Setup flutter
        run: |
          cd "$BUILD_DIR"
          git config --global --add safe.directory "$BUILD_DIR/submodules/flutter"
          submodules/flutter/bin/flutter doctor -v
          submodules/flutter/bin/flutter config --no-analytics
          submodules/flutter/bin/flutter pub get
      - name: Build x86_64 apk
        run: |
          cd "$BUILD_DIR"
          submodules/flutter/bin/flutter build apk --release --split-per-abi --build-number=$(( ${{ env.VERSION_CODE }} * 10 + 1 )) --build-name=${{ env.VERSION }} --target-platform=android-x64
      - name: Build arm apk
        run: |
          cd "$BUILD_DIR"
          submodules/flutter/bin/flutter build apk --release --split-per-abi --build-number=$(( ${{ env.VERSION_CODE }} * 10 + 2 )) --build-name=${{ env.VERSION }} --target-platform=android-arm
      - name: Build arm64 apk
        run: |
          cd "$BUILD_DIR"
          submodules/flutter/bin/flutter build apk --release --split-per-abi --build-number=$(( ${{ env.VERSION_CODE }} * 10 + 3 )) --build-name=${{ env.VERSION }} --target-platform=android-arm54
      - name: Upload artifacts
        uses: actions/upload-artifact@v3
        with:
          name: apks
          path: "$BUILD_DIR/build/app/outputs/flutter-apk/*.apk"

